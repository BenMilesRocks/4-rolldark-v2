{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<!-- Background overlay to cover home image -->
<div class="overlay"></div>

<div class="container mt-5 text-light">
    <div class="row">
        <div class="col-12 col-md-6">
            <hr>
            <h2 class="logo-font mb-4">Product Management</h2>
            <h5>Add a Product</h5>
            <hr>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-md-6">
            <form method="POST" action="{% url 'add_product' %}" class="form mb-2" enctype="multipart/form-data" id="form">
                {% csrf_token %}

                <!-- Hidden Game Dates, updated using JS functions on submission -->
                <div hidden id="game-dates-json">
                    {{ form.game_dates | as_crispy_field }}
                </div>
                
                <h5>General Info</h5>
                <hr>
                {{ form.category | as_crispy_field }}
                {{ form.sku | as_crispy_field }}
                {{ form.name | as_crispy_field }}
                {{ form.description | as_crispy_field }}
                {{ form.price | as_crispy_field }}
                <p class="fw-light">If this is for a game, input the price for a single session (campaign prices are calculated automatically from this)</p>
                <hr>
                <h5>Product Image</h5>
                <p class="fw-light">Only use image_url for products already saved on the AWS server. For everything else, upload a new image using the dropdown box below</p>
                {{ form.image | as_crispy_field }}
                {{ form.image_url | as_crispy_field }}
                <hr>
                <h5>Game Details</h5>
                <p class="fw-light">This info is specifically for Games. If this is not a game, leave these fields blank.</p>
                {{ form.game | as_crispy_field }}
                <p class="fw-bold">Uncheck this field if product is not a game</p>
                {{ form.date | as_crispy_field }}
                <p class="fw-light">This is the start date of the game. If this is a campaign, input the first session date</p>           
                {{ form.day | as_crispy_field }}
                <p class="fw-light">What day of the week the game is played</p>
                {{ form.location | as_crispy_field }}
                <p class="fw-light">If game is online, please input Online</p>
                {{ form.game_master | as_crispy_field }}

                <label for="dates" class="form-label">Number of game dates:</label>
                <input type="number" id="dates" name="dates" class="form-control rounded-0" value="0" min="0" onclick="addFields()">
                <div id="game-date-container"></div>



                {{ form.is_campaign | as_crispy_field }}
                {{ form.online_game | as_crispy_field }}
                <hr>
                <h5>Product admin</h5>
                {{ form.product_live | as_crispy_field }}
                {{ form.delivery_charge | as_crispy_field }}
                <div class="text-right">
                    <a class="btn btn-danger rounded-0" href="{% url 'products' %}">Cancel</a>
                    <button class="btn btn-light rounded-0" type="button" id="submit">Add Product</button>
                    <button type="submit" id="post" hidden>Hidden Submit Button</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block post_load_js %}
{{ block.super}}

<script type='text/javascript'>

    function addFields(){
        // Generate a dynamic number of inputs
        var number = document.getElementById("dates").value;
        // Get the element where the inputs will be added to
        var container = document.getElementById("game-date-container");
        // Remove every children it had before
        while (container.hasChildNodes()) {
            container.removeChild(container.lastChild);
        }
        for (i=0;i<number;i++){
            // Append a node with a random text
            container.appendChild(document.createTextNode("Date " + (i+1)));
            // Create an <input> element, set its type and name attributes
            var input = document.createElement("input");
            input.type = "date";
            input.name = "game-date-" + i;
            input.id = "game-date-" + i;
            container.appendChild(input);
            // Append a line break 
            container.appendChild(document.createElement("br"));
        }
    }

    document.getElementById("submit").addEventListener("click", function (event) {
        // Check how many game dates there are
        var dates = document.getElementById("dates").value;
        var jsonString = ""
        // adds game dates to jsonString
        for (i=0;i<dates;i++){
            var selection = document.getElementById("game-date-" + i).value;
            var number = i + 1
            jsonString += '"' + number + '"' + ':' + '"' + selection + '"' + ','
        }
        // creates JSON object for output
        var output = '{' + jsonString.slice(0, -1) + '}';
        // inputs this value into the form submission
        document.getElementById("id_game_dates").value = output;
        // submit form
        document.getElementById("post").click();
        });

</script>
{% endblock %}